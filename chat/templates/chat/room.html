{% extends "base.html" %}
{% load static %}

{% block title %}Chat Room{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/room.css' %}">
{% endblock %}

{% block content %}
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h2>Room: {{ room_name }}</h2>
        </header>

        <div id="chat-log" class="chat-log"></div>
        <div id="typing-indicator" style="padding: 0.5rem 1rem; font-style: italic; color: #666;"></div>


        <div class="chat-input-area">
            <input id="chat-message-input" type="text" placeholder="Type your message..." autocomplete="off" />
            <button id="chat-message-submit">Send</button>
        </div>
    </div>

    {{ room_name|json_script:"room-name" }}

<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const username = localStorage.getItem("chat_username") || "Anonymous";  // âœ… added

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );
    
    const messageInput = document.querySelector('#chat-message-input');
    const messageSubmit = document.querySelector('#chat-message-submit');

        // Typing event
    let typingTimeout;
    messageInput.addEventListener('input', function () {
        chatSocket.send(JSON.stringify({
            'typing': true,
            'username': username
        }));

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            chatSocket.send(JSON.stringify({
                'typing': false,
                'username': username
            }));
        }, 2000);  // Hide typing after 2 seconds of inactivity
    });

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        //typing
        if (data.typing !== undefined) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (data.username !== username) {
                typingIndicator.textContent = data.typing ? `${data.username} is typing...` : '';
            }
            return;
        }

        const log = document.querySelector('#chat-log');
        const msg = document.createElement('div');
        msg.className = 'chat-message';

        if (data.username === username) {
            msg.classList.add('own-message');
        }

        msg.textContent = `${data.username}: ${data.message}`;
        log.appendChild(msg);
        log.scrollTop = log.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    messageInput.focus();
    messageInput.onkeyup = function(e) {
        if (e.key === 'Enter') {
            messageSubmit.click();
        }
    };

    messageSubmit.onclick = function(e) {
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                message: message,
                username: username   
            }));
            messageInput.value = '';
        }
    };
</script>
</body>

{% endblock %}












